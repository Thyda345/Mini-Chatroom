<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Room - Imposter Game</title>
<style>
* { box-sizing: border-box; }
body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #121212; color: white; overflow: hidden; }

/* LOGIN SCREEN */
#loginScreen { 
    height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; 
    background-image: url("https://i.pinimg.com/originals/d5/84/0b/d5840b194bc468e606984aa99f6558c8.gif"); 
    background-size: cover; background-position: center; position: relative; z-index: 10;
}
#loginScreen::before { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.6); }
#loginScreen * { position: relative; z-index: 2; }
#loginScreen input { margin: 10px; padding: 12px; width: 260px; border-radius: 8px; border: none; }

/* MAIN LAYOUT */
.app { height: 100vh; display: none; flex-direction: row; background: #1e2134; }
.sidebar { width: 200px; background: #2b2b3a; border-right: 1px solid #444; display: flex; flex-direction: column; padding: 15px; }
.player-item { padding: 5px 0; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
.status-dot { width: 8px; height: 8px; background: #4caf50; border-radius: 50%; }

.chat-main { flex: 1; display: flex; flex-direction: column; position: relative; }
.header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #2b2b3a; border-bottom: 1px solid #444; }
.logo { width: 35px; height: 35px; vertical-align: middle; border-radius: 50%; }

#messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
.message { padding: 6px 10px; border-radius: 6px; background: rgba(255,255,255,0.05); white-space: pre-wrap; }

button { cursor: pointer; border: none; border-radius: 8px; font-weight: bold; }
.btn-rules { background: #ff9800; color: white; padding: 5px 10px; margin-right: 5px; }
.btn-leave { background: #f44336; color: white; padding: 5px 10px; }
.btn-send { background: #2196f3; color: white; padding: 0 20px; }
.btn-start-game { background: #673ab7; color: white; padding: 12px 25px; border-radius: 25px; }

.gameConsent { 
    display: none; padding: 20px; text-align: center; background: #fff; color: #222; 
    border-radius: 12px; position: absolute; top: 50%; left: 50%; 
    transform: translate(-50%, -50%); width: 320px; box-shadow: 0 0 30px rgba(0,0,0,0.7); z-index: 1000; 
}

.inputBar { display: flex; padding: 15px; background: #2b2b3a; gap: 10px; }
.inputBar input { flex: 1; padding: 12px; border-radius: 8px; border: none; background: #3d3d4d; color: white; outline: none; }
</style>
</head>
<body>

<div id="loginScreen">
  <h2 style="color:white;">Mini Room Chat</h2>
  <input id="usernameInput" placeholder="Enter Username...">
  <div style="color:white; margin-bottom:10px;">
    Pick Color: <input type="color" id="colorPicker" value="#3498db" style="width:50px; padding:0; height:30px; vertical-align:middle;">
  </div>
  <button onclick="login()" style="padding:12px 40px; background:#2196f3; color:white;">JOIN</button>
</div>

<div class="app" id="chatApp">
  <div class="sidebar">
    <h3>Online (<span id="playerCount">0</span>)</h3>
    <div id="playerList"></div>
  </div>

  <div class="chat-main">
    <div class="header">
        <div>
            <img class="logo" src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHQzeTY2Nnl6aWs1aHNzYjZqbjBiYTMza2cxaGpzc3E3ODh4cGttcyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/OFBdpHZAfanrMB5RWJ/giphy.gif">
            <b>MINI ROOM</b>
        </div>
        <div>
            <button class="btn-rules" onclick="showRules()">Rules</button>
            <span id="userDisplay" style="color:#4fc3f7; margin-right:10px; font-weight:bold;"></span> 
            <button class="btn-leave" onclick="logout()">Leave</button>
        </div>
    </div>

    <div id="messages"></div>

    <div id="gameConsent" class="gameConsent">
      <h3 style="margin-top:0;">ðŸŽ® Game Invite</h3>
      <p id="voteStatus">Checking players...</p>
      <button style="background:#4caf50; color:white; padding: 10px 20px;" onclick="respondConsent(true)">YES</button>
      <button style="background:#f44336; color:white; padding: 10px 20px;" onclick="respondConsent(false)">NO</button>
    </div>

    <div class="inputBar">
      <input id="messageInput" placeholder="Type a message...">
      <button class="btn-send" onclick="sendMessage()">SEND</button>
    </div>

    <div style="padding:10px; text-align:center; background:#121212;">
      <button class="btn-start-game" onclick="startGameRequest()">ðŸ˜ˆ START IMPOSTER GAME</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, setDoc, getDoc, updateDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA3wCv1DIdjlPS-zEVQJXhjYsiC3G2dBJY",
  authDomain: "mini-chatroom-5710b.firebaseapp.com",
  projectId: "mini-chatroom-5710b"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let username = localStorage.getItem("username") || "";
let userColor = localStorage.getItem("userColor") || "#ffffff";
let onlineCount = 0;

// --- UTILS ---
async function sendSystem(msg) {
  await addDoc(collection(db, "messages"), { user: "SYSTEM", text: msg, time: Date.now() });
}

window.showRules = () => {
    alert("ðŸ“œ GAME RULES:\n1. Everyone online must say YES.\n2. One person is the IMPOSTER.\n3. Victims know the topic.\n4. Find the imposter!");
};

// --- AUTH ---
window.login = async () => {
  const name = document.getElementById("usernameInput").value.trim();
  if (!name) return alert("Enter a name!");
  
  username = name;
  userColor = document.getElementById("colorPicker").value;
  localStorage.setItem("username", username);
  localStorage.setItem("userColor", userColor);
  
  await setDoc(doc(db, "users", username), { username, color: userColor });
  await sendSystem(`ðŸ‘‹ ${username} has joined!`);
  
  // SMALL DELAY TO ENSURE FIREBASE SEES THE MESSAGE
  setTimeout(() => { location.reload(); }, 800);
};

window.logout = async () => {
  await sendSystem(`ðŸšª ${username} left.`);
  await deleteDoc(doc(db, "users", username));
  localStorage.clear();
  location.reload();
};

window.sendMessage = async () => {
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if (!text || !username) return;
  input.value = "";
  await addDoc(collection(db, "messages"), { user: username, text: text, time: Date.now(), color: userColor });
};

document.getElementById("messageInput").addEventListener("keydown", (e) => { if(e.key === "Enter") window.sendMessage(); });

// --- SIDEBAR SYNC ---
onSnapshot(collection(db, "users"), (snap) => {
    const listDiv = document.getElementById("playerList");
    listDiv.innerHTML = "";
    onlineCount = snap.size;
    document.getElementById("playerCount").textContent = onlineCount;
    snap.forEach(d => {
        const p = d.data();
        const div = document.createElement("div");
        div.className = "player-item";
        div.innerHTML = `<div class="status-dot"></div> <span style="color:${p.color}">${p.username}</span>`;
        listDiv.appendChild(div);
    });
});

// --- GAME LOGIC ---
window.startGameRequest = async () => {
  if (onlineCount < 3) return alert("You need at least 3 players online!");
  await setDoc(doc(db, "game", "request"), { active: true, responses: {}, time: Date.now() });
  await sendSystem(`ðŸ“¢ ${username} started a game request! Everyone check your screen.`);
};

window.respondConsent = async (yes) => {
  const ref = doc(db, "game", "request");
  const snap = await getDoc(ref);
  if (!snap.exists()) return;

  const responses = snap.data().responses || {};
  responses[username] = yes;
  await updateDoc(ref, { responses });

  if (yes === false) {
    await sendSystem(`âŒ ${username} said NO. Canceled.`);
    await setDoc(ref, { active: false, responses: {} });
  } else {
    await sendSystem(`âœ… ${username} is ready!`);
    const yesCount = Object.values(responses).filter(v => v === true).length;
    
    if (yesCount >= onlineCount) {
      window.startGame();
      await setDoc(ref, { active: false, responses: {} });
    }
  }
};

window.startGame = async () => {
  // GET LATEST PLAYERS FROM DB TO ASSIGN ROLES
  const snap = await getDocs(collection(db, "users"));
  const playerList = [];
  snap.forEach(d => playerList.push(d.id));

  const impIndex = Math.floor(Math.random() * playerList.length);
  const imposter = playerList[impIndex];
  const topics = ["Pizza", "Cinema", "Airplane", "Library", "Beach", "Gym"];
  const topic = topics[Math.floor(Math.random() * topics.length)];

  await sendSystem(`ðŸ“œ GAME RULES:
1. One player is the ðŸ˜ˆ IMPOSTER.
2. Everyone else knows the topic.
3. Find the imposter!`);

  await sendSystem("ðŸŽ® GAME START! Everyone look at your Role Alert.");

  // TRIGGER ROLE ASSIGNMENT IN THE DATABASE
  await setDoc(doc(db, "game", "active_session"), {
    imposter: imposter,
    topic: topic,
    players: playerList,
    time: Date.now()
  });
};

// --- GLOBAL SESSION LISTENER (THIS GIVES THE ROLE) ---
onSnapshot(doc(db, "game", "active_session"), (snap) => {
    const session = snap.data();
    if (session && Date.now() - session.time < 5000) { // Only show if game just started
        if (username === session.imposter) {
            alert("ðŸ˜ˆ ROLE: IMPOSTER\nBlend in! You don't know the topic.");
        } else if (session.players.includes(username)) {
            alert(`ðŸ˜‡ ROLE: VICTIM\nTopic: ${session.topic}`);
        }
    }
});

// --- MESSAGE LISTENER ---
onSnapshot(query(collection(db, "messages"), orderBy("time")), (snap) => {
  const mDiv = document.getElementById("messages");
  mDiv.innerHTML = "";
  snap.forEach(d => {
    const m = d.data();
    const div = document.createElement("div");
    div.className = "message";
    div.style.color = m.user === "SYSTEM" ? "#ffcc00" : m.color || "white";
    div.textContent = `${m.user}: ${m.text}`;
    mDiv.appendChild(div);
  });
  mDiv.scrollTop = mDiv.scrollHeight;
});

// --- CONSENT LISTENER ---
onSnapshot(doc(db, "game", "request"), (snap) => {
  const data = snap.data();
  const consentDiv = document.getElementById("gameConsent");
  if (data && data.active) {
    const hasVoted = data.responses && data.responses[username] !== undefined;
    const currentYes = Object.values(data.responses).filter(v => v === true).length;
    document.getElementById("voteStatus").textContent = `Ready: ${currentYes} / ${onlineCount}`;
    consentDiv.style.display = hasVoted ? "none" : "block";
  } else {
    consentDiv.style.display = "none";
  }
});

if (username) {
  document.getElementById("chatApp").style.display = "flex";
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("userDisplay").textContent = username;
}
</script>
</body>
</html>
