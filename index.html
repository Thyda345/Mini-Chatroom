<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Room - Imposter Game</title>

<style>
* { box-sizing: border-box; }

body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #121212;
    color: white;
}

/* LOGIN SCREEN */
#loginScreen {
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background-image: url("https://i.pinimg.com/originals/d5/84/0b/d5840b194bc468e606984aa99f6558c8.gif");
    background-size: cover;
    background-position: center;
    position: relative;
}

#loginScreen::before {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.6);
}

#loginScreen * { position: relative; z-index: 2; }
#loginScreen h2 { margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
#loginScreen input, #loginScreen button { margin: 8px; padding: 12px; border-radius: 8px; border: none; font-size: 1rem; }
#loginScreen input { width: 260px; color: #000; }
#loginScreen button { background: #2196f3; color: white; cursor: pointer; font-weight: bold; width: 120px; }
#loginScreen button:hover { background: #1976d2; }

/* CHAT APP */
.app { height: 100vh; display: none; flex-direction: column; background: #1e2134; }
.header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: #2b2b3a; border-bottom: 1px solid #3d3d4d; }
.logo-container { display: flex; align-items: center; gap: 10px; }
.logo { width: 32px; height: 32px; object-fit: contain; }

#messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
.message { padding: 4px 8px; border-radius: 4px; line-height: 1.4; word-wrap: break-word; }

.inputBar { display: flex; padding: 15px; background: #2b2b3a; gap: 10px; }
.inputBar input { flex: 1; padding: 12px; border-radius: 8px; border: none; background: #3d3d4d; color: white; outline: none; }
.inputBar button { padding: 0 20px; border-radius: 8px; border: none; background: #2196f3; color: white; cursor: pointer; font-weight: bold; }

.gameBar { padding: 10px; background: #121212; text-align: center; border-top: 1px solid #333; }
.gameBar button { padding: 10px 20px; border-radius: 20px; border: none; background: #673ab7; color: white; cursor: pointer; font-weight: bold; }
.gameBar button:hover { background: #5e35b1; }

.gameConsent { display: none; padding: 15px; text-align: center; background: #fff; color: #222; border-radius: 12px 12px 0 0; position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); z-index: 100; }
.gameConsent button { margin: 5px; padding: 8px 25px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
.btn-yes { background: #4caf50; color: white; }
.btn-no { background: #f44336; color: white; }

#userDisplay { font-weight: bold; color: #4fc3f7; margin-right: 10px; }
.logout-btn { background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
</style>
</head>

<body>

<div id="loginScreen">
  <h2>Mini Room Chat</h2>
  <input id="usernameInput" placeholder="Enter Username...">
  <div style="display:flex; align-items:center; gap:10px;">
    <span>Pick Color:</span>
    <input type="color" id="colorPicker" value="#3498db" style="width:50px; padding:2px;">
  </div>
  <button onclick="login()">JOIN</button>
</div>

<div class="app" id="chatApp">
  <div class="header">
    <div class="logo-container">
        <img class="logo" src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHQzeTY2Nnl6aWs1aHNzYjZqbjBiYTMza2cxaGpzc3E3ODh4cGttcyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/OFBdpHZAfanrMB5RWJ/giphy.gif"> 
        <b>MINI ROOM</b>
    </div>
    <div>
        <span id="userDisplay"></span> 
        <button class="logout-btn" onclick="logout()">Leave</button>
    </div>
  </div>

  <div id="messages"></div>

  <div id="gameConsent" class="gameConsent">
    <p style="font-weight:bold; margin-bottom:10px;">Start Imposter Game?</p>
    <button class="btn-yes" onclick="respondConsent(true)">YES</button>
    <button class="btn-no" onclick="respondConsent(false)">NO</button>
  </div>

  <div class="inputBar">
    <input id="messageInput" placeholder="Type a message...">
    <button onclick="sendMessage()">SEND</button>
  </div>

  <div class="gameBar">
    <button onclick="startGameRequest()">ðŸ˜ˆ START IMPOSTER GAME</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, setDoc, getDoc, updateDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// -------- FIREBASE CONFIG --------
const firebaseConfig = {
  apiKey: "AIzaSyA3wCv1DIdjlPS-zEVQJXhjYsiC3G2dBJY",
  authDomain: "mini-chatroom-5710b.firebaseapp.com",
  projectId: "mini-chatroom-5710b"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// -------- DOM ELEMENTS --------
const loginScreen = document.getElementById("loginScreen");
const chatApp = document.getElementById("chatApp");
const userDisplay = document.getElementById("userDisplay");
const messagesDiv = document.getElementById("messages");
const consentDiv = document.getElementById("gameConsent");
const inputEl = document.getElementById("messageInput");

// -------- GAME STATE --------
let username = localStorage.getItem("username") || "";
let players = [];
let gameState = { phase: "waiting" };

const topics = {
  Place: ["Hotel", "Beach", "School", "Cinema", "Club", "Gym", "Airport"],
  Fruit: ["Durian", "Banana", "Strawberry", "Mango", "Watermelon"],
  Food: ["Pizza", "Burger", "Sushi", "Pasta", "Taco"],
  Item: ["Laptop", "Smartwatch", "Umbrella", "Backpack"]
};

// -------- CORE FUNCTIONS --------

async function sendSystem(msg) {
  await addDoc(collection(db, "messages"), { 
    user: "SYSTEM", 
    text: msg, 
    time: Date.now() 
  });
}

async function fetchPlayers() {
  const snap = await getDocs(collection(db, "users"));
  players = [];
  snap.forEach(d => players.push(d.id));
}

// -------- WINDOW GLOBALS (For HTML onclick) --------

window.login = async () => {
  const name = document.getElementById("usernameInput").value.trim();
  if (!name) return alert("Please enter a username!");
  
  username = name;
  localStorage.setItem("username", username);
  const color = document.getElementById("colorPicker").value;

  await setDoc(doc(db, "users", username), { username, color });
  
  loginScreen.style.display = "none";
  chatApp.style.display = "flex";
  userDisplay.textContent = username;

  listenMessages();
  fetchPlayers();
  await sendSystem(`ðŸ‘‹ ${username} joined the chat!`);
};

window.logout = async () => {
  if (!username) return;
  if (gameState.phase !== "waiting") {
    if (!confirm("Game is active! If you leave, the game might break. Leave?")) return;
  }
  
  await sendSystem(`ðŸšª ${username} left the chat.`);
  await deleteDoc(doc(db, "users", username));
  localStorage.removeItem("username");
  location.reload();
};

window.sendMessage = async () => {
  const text = inputEl.value.trim();
  if (!text) return;
  
  const userSnap = await getDoc(doc(db, "users", username));
  const color = userSnap.exists() ? userSnap.data().color : "#ffffff";
  
  inputEl.value = "";
  await addDoc(collection(db, "messages"), { 
    user: username, 
    text: text, 
    time: Date.now(), 
    color: color 
  });
};

inputEl.addEventListener("keydown", (e) => { if(e.key === "Enter") window.sendMessage(); });

// -------- GAME LOGIC --------

window.startGameRequest = async () => {
  await fetchPlayers();
  if (players.length < 3) {
    return alert("You need at least 3 players online to start!");
  }
  const ref = doc(db, "game", "request");
  await setDoc(ref, { active: true, responses: {}, time: Date.now() });
  await sendSystem(`ðŸ“¢ ${username} wants to start the Imposter Game! Everyone vote now.`);
};

window.respondConsent = async (yes) => {
  const ref = doc(db, "game", "request");
  const snap = await getDoc(ref);
  if (!snap.exists()) return;

  const data = snap.data();
  const responses = data.responses || {};
  responses[username] = yes;

  await updateDoc(ref, { responses });
  consentDiv.style.display = "none"; // Hide UI for this user immediately

  const status = yes ? "âœ… joined" : "âŒ declined";
  await sendSystem(`${username} ${status} the game.`);

  // Logic to count
  const yesCount = Object.values(responses).filter(v => v === true).length;
  const noCount = Object.values(responses).filter(v => v === false).length;

  if (noCount > 0) {
    await sendSystem("âš ï¸ Game Canceled: Someone declined the invite.");
    await setDoc(ref, { active: false, responses: {} });
  } else if (yesCount >= 3) {
    window.startGame();
    await setDoc(ref, { active: false, responses: {} });
  }
};

window.startGame = () => {
  gameState.phase = "playing";
  
  const impIndex = Math.floor(Math.random() * players.length);
  const imposter = players[impIndex];
  
  const cats = Object.keys(topics);
  const cat = cats[Math.floor(Math.random() * cats.length)];
  const topic = topics[cat][Math.floor(Math.random() * topics[cat].length)];

  // 1. Post Rules
  const rules = `
ðŸ“œ GAME RULES:
1. One player is the ðŸ˜ˆ IMPOSTER.
2. Everyone else knows the topic: [${cat}].
3. Discussion: Ask questions to find the imposter.
4. Imposter: Try to guess the topic and blend in!
5. Vote: Use the chat to agree on who to kick.`;
  
  sendSystem(rules);
  sendSystem("ðŸŽ® GAME BEGUN! Look at the alert on your screen for your role.");

  // 2. Alert Roles
  players.forEach(p => {
    if (p === username) {
      if (p === imposter) {
        alert("ðŸ˜ˆ ROLE: YOU ARE THE IMPOSTER!\nBlend in and don't let them catch you.");
      } else {
        alert(`ðŸ˜‡ ROLE: YOU ARE A VICTIM.\nTopic: ${topic}\nCategory: ${cat}`);
      }
    }
  });
};

// -------- LISTENERS --------

function listenMessages() {
  const q = query(collection(db, "messages"), orderBy("time"));
  onSnapshot(q, (snapshot) => {
    messagesDiv.innerHTML = "";
    snapshot.forEach((doc) => {
      const m = doc.data();
      const div = document.createElement("div");
      div.className = "message";
      
      if (m.user === "SYSTEM") {
        div.style.color = "#ffcc00";
        div.style.background = "rgba(255, 204, 0, 0.1)";
        div.style.fontWeight = "bold";
      } else {
        div.style.color = m.color || "white";
      }
      
      div.textContent = `${m.user}: ${m.text}`;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

onSnapshot(doc(db, "game", "request"), (snap) => {
  if (!snap.exists()) return;
  const data = snap.data();
  // Show pop-up only if game is active AND user hasn't voted yet
  const hasVoted = data.responses && data.responses[username] !== undefined;
  consentDiv.style.display = (data.active && !hasVoted) ? "block" : "none";
});

// -------- INITIALIZE --------
if (username) {
  loginScreen.style.display = "none";
  chatApp.style.display = "flex";
  userDisplay.textContent = username;
  listenMessages();
  fetchPlayers();
}

</script>
</body>
</html>
