<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Room - Final Sync Fix</title>
<style>
* { box-sizing: border-box; }
body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #121212; color: white; overflow: hidden; }
#loginScreen { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #1a1a1a; position: relative; }
#loginScreen input { margin: 10px; padding: 12px; width: 260px; border-radius: 8px; border: none; }
.app { height: 100vh; display: none; flex-direction: row; background: #1e2134; }
.sidebar { width: 180px; background: #2b2b3a; border-right: 1px solid #444; padding: 15px; overflow-y: auto; }
.chat-main { flex: 1; display: flex; flex-direction: column; position: relative; height: 100vh; }
.header { height: 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: #2b2b3a; border-bottom: 1px solid #444; }
#roleCard { display: none; padding: 12px; text-align: center; font-weight: bold; font-size: 1.1rem; border-bottom: 3px solid rgba(0,0,0,0.5); }
#messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
.message { padding: 8px 12px; border-radius: 6px; background: rgba(255,255,255,0.05); }
.sys-msg { background: #ffcc00 !important; color: black !important; font-weight: bold; text-align: center; border-radius: 8px; }
.inputBar { display: flex; padding: 10px; background: #2b2b3a; gap: 8px; }
.inputBar input { flex: 1; padding: 12px; border-radius: 8px; border: none; background: #3d3d4d; color: white; }
button { cursor: pointer; border: none; border-radius: 8px; font-weight: bold; padding: 10px 15px; }
#gameConsent { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: white; color: black; padding: 25px; border-radius: 15px; z-index: 9999; text-align: center; width: 320px; box-shadow: 0 0 50px black; }
</style>
</head>
<body>

<div id="loginScreen">
  <h2 style="color:white;">MINI ROOM</h2>
  <input id="usernameInput" placeholder="Username...">
  <input type="color" id="colorPicker" value="#3498db">
  <button onclick="login()" style="background:#2196f3; color:white; width: 260px;">JOIN</button>
</div>

<div class="app" id="chatApp">
  <div class="sidebar">
    <h3 style="font-size: 0.9rem;">ONLINE (<span id="playerCount">0</span>)</h3>
    <div id="playerList"></div>
  </div>
  <div class="chat-main">
    <div class="header">
        <button onclick="resetGameManually()" style="background:#555; color:white; font-size:10px;">RESET</button>
        <div><span id="userDisplay"></span> <button onclick="logout()" style="background:#f44336; color:white; padding:4px 8px;">Leave</button></div>
    </div>
    <div id="roleCard"></div>
    <div id="messages"></div>
    <div class="inputBar">
      <input id="messageInput" placeholder="Message..." autocomplete="off">
      <button id="sendBtn" style="background:#2196f3; color:white;">SEND</button>
    </div>
    <div style="padding:10px; text-align:center; background:#121212;">
      <button onclick="startGameRequest()" style="background:#673ab7; color:white; width:100%; max-width:200px;">üòà START GAME</button>
    </div>
  </div>
</div>

<div id="gameConsent">
    <h3>Start Game?</h3>
    <p id="voteStatus">Waiting...</p>
    <div style="display:flex; gap:10px;">
        <button id="yesBtn" onclick="respondConsent(true)" style="background:#4caf50; color:white; flex:1;">YES</button>
        <button onclick="respondConsent(false)" style="background:#f44336; color:white; flex:1;">NO</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyA3wCv1DIdjlPS-zEVQJXhjYsiC3G2dBJY", authDomain: "mini-chatroom-5710b.firebaseapp.com", projectId: "mini-chatroom-5710b" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Ensures every browser instance has a unique ID
let myID = localStorage.getItem("myID") || Math.random().toString(36).slice(2, 11);
localStorage.setItem("myID", myID);
let username = localStorage.getItem("username") || "";
let myColor = localStorage.getItem("userColor") || "#ffffff";
let isImposter = false;
let killAlerted = false;

async function postSys(txt) {
    await addDoc(collection(db, "messages"), { user: "SYSTEM", text: txt, time: Date.now(), isSystem: true });
}

function postLocalSys(txt) {
    const mDiv = document.getElementById("messages");
    mDiv.innerHTML += `<div class="message sys-msg" style="background:#ff3d00 !important; color:white !important; border: 2px solid white;">[PRIVATE] ${txt}</div>`;
    mDiv.scrollTop = mDiv.scrollHeight;
}

window.login = async () => {
    const name = document.getElementById("usernameInput").value.trim();
    if (!name) return;
    localStorage.setItem("username", name);
    localStorage.setItem("userColor", document.getElementById("colorPicker").value);
    await setDoc(doc(db, "users", myID), { username: name, color: document.getElementById("colorPicker").value, lastSeen: Date.now(), id: myID });
    await postSys(`üëã <b>${name}</b> joined the room!`);
    location.reload();
};

window.logout = async () => {
    await postSys(`üèÉ <b>${username}</b> left.`);
    await deleteDoc(doc(db, "users", myID));
    localStorage.clear();
    location.reload();
};

// --- CORE FIX: UNIQUE READY SYSTEM ---
window.startGameRequest = async () => {
    const readySnap = await getDocs(collection(db, "readyPlayers"));
    const batch = writeBatch(db);
    readySnap.forEach(d => batch.delete(d.ref));
    await batch.commit();

    await setDoc(doc(db, "game", "request"), { active: true, triggered: false, time: Date.now() });
    await postSys("üîî <b>GAME REQUESTED!</b> Please click YES to start.");
};

window.respondConsent = async (val) => {
    if(val === true) {
        // Save using myID as key so multiple users don't overwrite each other
        await setDoc(doc(db, "readyPlayers", myID), { name: username, ready: true });
        await postSys(`‚úÖ <b>${username}</b> is READY!`);
    }
    document.getElementById("gameConsent").style.display = "none";
};

onSnapshot(doc(db, "game", "request"), (snap) => {
    const data = snap.data();
    if (data && data.active && !data.triggered) {
        getDoc(doc(db, "readyPlayers", myID)).then(d => {
            if(!d.exists()) document.getElementById("gameConsent").style.display = "block";
        });
    } else {
        document.getElementById("gameConsent").style.display = "none";
    }
});

onSnapshot(collection(db, "readyPlayers"), async (snap) => {
    const count = snap.size;
    document.getElementById("voteStatus").textContent = `${count} Players Ready`;

    const reqSnap = await getDoc(doc(db, "game", "request"));
    if (count >= 3 && reqSnap.exists() && !reqSnap.data().triggered) {
        const playerIds = snap.docs.map(d => d.id).sort();
        if (myID === playerIds[0]) {
            await updateDoc(doc(db, "game", "request"), { triggered: true });
            await postSys("üö® <b>3 PLAYERS READY!</b> Game starting...");
            
            setTimeout(async () => {
                const uSnap = await getDocs(collection(db, "users"));
                const players = [];
                uSnap.forEach(u => players.push(u.data().username));
                
                const imposter = players[Math.floor(Math.random() * players.length)];
                const topics = ["Roblox", "YouTube", "Food", "School", "Movies"];
                
                await setDoc(doc(db, "game", "session"), { 
                    imposter, 
                    topic: topics[Math.floor(Math.random() * topics.length)], 
                    rolesActive: true, 
                    round: 1 
                });
                await updateDoc(doc(db, "game", "request"), { active: false });
            }, 3000);
        }
    }
});

// --- GAMEPLAY LOGIC ---
onSnapshot(doc(db, "game", "session"), (snap) => {
    const data = snap.data();
    const card = document.getElementById("roleCard");
    if (data && data.rolesActive) {
        card.style.display = "block";
        isImposter = (username === data.imposter);
        if (isImposter) {
            card.style.background = "#b71c1c";
            card.innerHTML = `üòà YOU ARE THE IMPOSTER!`;
            if(data.round === 2 && !killAlerted) {
                postLocalSys("üî™ ROUND 2: Use <b>/kill username</b> privately!");
                killAlerted = true;
            }
        } else {
            card.style.background = "#2e7d32";
            card.innerHTML = `üòá CIVILIAN | TOPIC: ${data.topic}`;
        }
    } else {
        card.style.display = "none";
        killAlerted = false;
    }
});

window.sendMessage = async () => {
    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if (!text) return;

    if (text.startsWith("/vote ")) {
        const target = text.replace("/vote ", "");
        input.value = "";
        await postSys(`üó≥Ô∏è <b>${username}</b> voted for <b>${target}</b>!`);
    } else if (text.startsWith("/kill ")) {
        const target = text.replace("/kill ", "");
        input.value = "";
        const gSnap = await getDoc(doc(db, "game", "session"));
        if (isImposter && gSnap.data().round >= 2) {
            await postSys(`ü©∏ <b>ELIMINATION:</b> ${target} was killed!`);
        } else {
            postLocalSys("‚ùå You cannot kill yet.");
        }
    } else {
        await addDoc(collection(db, "messages"), { user: username, text: text, time: Date.now(), color: myColor });
        input.value = "";
    }
};

document.getElementById("sendBtn").onclick = window.sendMessage;
document.getElementById("messageInput").onkeydown = (e) => { if(e.key === "Enter") window.sendMessage(); };

onSnapshot(query(collection(db, "messages"), orderBy("time")), (snap) => {
    const mDiv = document.getElementById("messages");
    mDiv.innerHTML = "";
    snap.forEach(d => {
        const m = d.data();
        mDiv.innerHTML += `<div class="message ${m.isSystem ? 'sys-msg' : ''}" style="color:${m.isSystem ? 'black' : (m.color || 'white')}">${m.isSystem ? '' : `<b>${m.user}:</b> `}${m.text}</div>`;
    });
    mDiv.scrollTop = mDiv.scrollHeight;
});

onSnapshot(collection(db, "users"), (snap) => {
    const listDiv = document.getElementById("playerList");
    let count = 0;
    listDiv.innerHTML = "";
    snap.forEach(d => {
        const u = d.data();
        count++;
        listDiv.innerHTML += `<div style="color:${u.color}; padding: 2px 0;">‚óè ${u.username}</div>`;
    });
    document.getElementById("playerCount").textContent = count;
});

window.resetGameManually = async () => {
    await setDoc(doc(db, "game", "session"), { rolesActive: false, round: 1 });
    await setDoc(doc(db, "game", "request"), { active: false });
    const readySnap = await getDocs(collection(db, "readyPlayers"));
    const batch = writeBatch(db);
    readySnap.forEach(d => batch.delete(d.ref));
    await batch.commit();
    await postSys("üßπ Room reset.");
};

if (username) {
    document.getElementById("chatApp").style.display = "flex";
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("userDisplay").textContent = username;
    document.getElementById("userDisplay").style.color = myColor;
}
</script>
</body>
</html>s
