<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Room</title>
    <style>
        /* KEEPING YOUR EXACT STYLE */
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            font-family: 'Segoe UI', sans-serif; 
            background: #0a0a0c; 
            color: #e0e0e0;
            overflow: hidden; 
        }
        .overlay-card { 
            position: fixed; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #2c3e50; 
            border: 2px solid #3498db; 
            padding: 15px 25px; 
            border-radius: 12px; 
            z-index: 9999; 
            display: none; 
            text-align: center; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        }
        #loginScreen { 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            background: url("https://i.pinimg.com/originals/d5/84/0b/d5840b194bc468e606984aa99f6558c8.gif") center/cover; 
            position: relative; 
            z-index: 10; 
        }
        #loginScreen::before { 
            content: ""; 
            position: absolute; 
            inset: 0; 
            background: #000000bf; 
            backdrop-filter: blur(4px); 
        }
        #loginContainer { 
            position: relative; 
            z-index: 2; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        #loginContainer input { 
            margin: 10px; 
            padding: 15px; 
            width: 280px; 
            border-radius: 12px;
            border: 1px solid #444; 
            background: #1a1a1a; 
            color: white; 
            outline: none; 
        }
        .app { 
            height: 100vh; 
            display: none; 
            flex-direction: row; 
            background: #0f0f13; 
        }
        .sidebar { 
            width: 220px; 
            background: #16161d; 
            border-right: 1px solid #2d2d3d; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
        }
        #playerList { 
            flex: 1; 
            overflow-y: auto; 
            margin-top: 10px; 
        }
        .chat-main { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
        }
        .header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 12px 20px; 
            background: #16161d; 
            border-bottom: 1px solid #2d2d3d; 
        }
        .logo { 
            width: 35px; 
            height: 35px; 
            border-radius: 50%; 
            border: 2px solid #3498db; 
        }
        #phaseTimerDisplay { 
            background: #e74c3c; 
            color: white; 
            padding: 4px 10px; 
            border-radius: 5px; 
            font-family: monospace; 
            font-weight: bold; 
            display: none; 
        }
        #messages { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            background: #0f0f13; 
        }
        .message { 
            padding: 10px 15px; 
            border-radius: 12px; 
            background: #ffffff0d; 
            max-width: 85%; 
        }
        .sys-msg { 
            background: #f1c40f !important; 
            color: #000 !important; 
            font-weight: 900; 
            text-align: center;
            max-width: 100%; 
            border: 2px solid #000; 
        }
        .topic-msg { 
            background: #3498db !important; 
            color: white !important; 
            font-style: italic; 
            border: 1px solid #fff; 
        }
        .inputBar { 
            display: flex; 
            padding: 20px; 
            background: #16161d; 
            gap: 10px; 
            border-top: 1px solid #2d2d3d; 
        }
        .inputBar input { 
            flex: 1; 
            padding: 14px; 
            border-radius: 10px; 
            border: 1px solid #3d3d4d; 
            background: #0a0a0c; 
            color: white; 
        }
        button { 
            cursor: pointer; 
            border: none; 
            border-radius: 10px; 
            font-weight: bold; 
            padding: 10px 20px; 
        }
        .joinBtn{ background:#2ecc71; color:white; }
        .cancelBtn{ background:#e74c3c; color:white; }
        .loginBtn{ background:#3498db; color:white; width:280px; margin-top: 10px;}
        .impAlert{ background:#e74c3c!important; color:white!important; }
    </style>
</head>

<body>

<div id="inviteBox" class="overlay-card">
    <p id="inviteText">New Game Starting...</p>
    <div id="readyList" style="font-size: 12px; margin-bottom: 10px; color: #2ecc71;"></div>
    <div style="display:flex; gap:10px; justify-content:center;">
        <button id="joinBtn" class="joinBtn">ACCEPT</button>
        <button id="cancelBtn" class="cancelBtn">CANCEL</button>
    </div>
</div>

<div id="loginScreen">
    <div id="loginContainer">
        <h1 style="color:white; letter-spacing: 5px;">MINI ROOM</h1>
        <input id="usernameInput" placeholder="Enter Username...">
        <input type="color" id="colorPicker" value="#3498db" style="height: 50px;">
        <button id="loginBtn" class="loginBtn">ENTER SYSTEM</button>
    </div>
</div>

<div class="app" id="chatApp">
    <div class="sidebar">
        <h3>ONLINE (<span id="playerCount">0</span>)</h3>
        <div id="playerList"></div>
        <button id="resetGameBtn" style="background:#e67e22; color:white; font-size:11px; margin-top:10px; padding:5px;">RESET SYSTEM</button>
    </div>
    
    <div class="chat-main">
        <div class="header">
            <div style="display:flex; align-items:center; gap:10px;">
                <img class="logo" src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExbDVvbThmd2lwc3R0d3I0aXR0MmN4eG4zdzB5eG1uenNybTZteHY2aSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/CQ3C59W0L5lpgBWN6E/giphy.gif">
                <span style="color:#3498db; font-weight:bold;">MINI ROOM</span>
                <span id="phaseTimerDisplay"></span>
            </div>
            <button id="logoutBtn" style="background:#e74c3c; color:white; padding:5px 10px;">LEAVE</button>
        </div>
        <div id="messages"></div>
        <div class="inputBar">
            <input id="messageInput" placeholder="Type a message..." autocomplete="off">
            <button id="sendBtn" style="background:#3498db; color:white;">SEND</button>
        </div>
        <div style="padding:15px; background:#16161d; border-top:1px solid #2d2d3d;">
            <button id="startBtn" style="background:#8e44ad; color:white; width:100%;">INVITE OTHERS TO PLAY</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, setDoc, updateDoc, deleteDoc, getDocs, arrayUnion, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyA3wCv1DIdjlPS-zEVQJXhjYsiC3G2dBJY", authDomain: "mini-chatroom-5710b.firebaseapp.com", projectId: "mini-chatroom-5710b" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let myID = localStorage.getItem("myID") || Math.random().toString(36).slice(2);
localStorage.setItem("myID", myID);
let username = localStorage.getItem("username") || "";
let myColor = localStorage.getItem("userColor") || "#3498db";
let allPlayerIDs = [];
let localTimerEnd = 0;
let currentPhase = "";
let roleShown = false;

const TOPICS = ["Crush", "Ex", "Sugar Daddy", "Emo", "Ariana Grande", "Goku's panties"];

// 1. TIMER LOOP (ONE INSTANCE ONLY)
setInterval(async () => {
    if (localTimerEnd <= 0) return;
    const remaining = Math.max(0, Math.floor((localTimerEnd - Date.now()) / 1000));
    const display = document.getElementById("phaseTimerDisplay");
    
    if (remaining > 0) {
        display.style.display = "block";
        display.textContent = remaining + "s";
    } else {
        display.style.display = "none";
        if (allPlayerIDs[0] === myID && currentPhase !== "") {
            const p = currentPhase;
            currentPhase = ""; // Freeze protection
            localTimerEnd = 0;
            await runNextPhase(p);
        }
    }
}, 1000);

async function runNextPhase(p) {
    const ref = doc(db, "game", "session");
    if (p === "rules") {
        const uSnap = await getDocs(collection(db, "users"));
        const names = uSnap.docs.map(u => u.data().username);
        const imp = names[Math.floor(Math.random() * names.length)];
        await updateDoc(ref, { phase: "reveal", timerEnd: Date.now() + 8000, imposter: imp });
    } else if (p === "reveal") {
        await addDoc(collection(db, "messages"), { user: "SYSTEM", text: "ðŸ’¬ DISCUSSION START!", time: Date.now(), isSystem: true });
        await updateDoc(ref, { phase: "discussion", timerEnd: Date.now() + 120000 });
    } else if (p === "discussion") {
        await addDoc(collection(db, "messages"), { user: "SYSTEM", text: "ðŸ—³ï¸ VOTING START!", time: Date.now(), isSystem: true });
        await updateDoc(ref, { phase: "voting", timerEnd: Date.now() + 30000 });
    } else if (p === "voting") {
        await updateDoc(ref, { active: false });
    }
}

// 2. LOBBY & START
document.getElementById("startBtn").onclick = async () => {
    await setDoc(doc(db, "game", "lobby"), { active: true, ready: [username] });
};

document.getElementById("joinBtn").onclick = async () => {
    await updateDoc(doc(db, "game", "lobby"), { ready: arrayUnion(username) });
};

onSnapshot(doc(db, "game", "lobby"), async snap => {
    const data = snap.data();
    if (!data || !data.active) { document.getElementById("inviteBox").style.display = "none"; return; }
    
    document.getElementById("inviteBox").style.display = "block";
    document.getElementById("readyList").textContent = "Ready: " + data.ready.join(", ");

    // If 2+ people ready and I am host, start session
    if (data.ready.length >= 2 && allPlayerIDs[0] === myID) {
        await updateDoc(doc(db, "game", "lobby"), { active: false });
        await setDoc(doc(db, "game", "session"), {
            phase: "rules", timerEnd: Date.now() + 6000, active: true, 
            imposter: "", topic: TOPICS[Math.floor(Math.random() * TOPICS.length)]
        });
    }
});

// 3. CORE UI & LISTENERS (REMAINING THE SAME)
document.getElementById("loginBtn").onclick = async () => {
    username = document.getElementById("usernameInput").value.trim();
    myColor = document.getElementById("colorPicker").value;
    if (!username) return;
    localStorage.setItem("username", username);
    localStorage.setItem("userColor", myColor);
    await setDoc(doc(db, "users", myID), { username, color: myColor });
    location.reload();
};

if (username) { document.getElementById("loginScreen").style.display = "none"; document.getElementById("chatApp").style.display = "flex"; }

document.getElementById("sendBtn").onclick = async () => {
    const text = document.getElementById("messageInput").value.trim();
    if (!text) return;
    await addDoc(collection(db, "messages"), { user: username, text, time: Date.now(), color: myColor });
    document.getElementById("messageInput").value = "";
};

onSnapshot(query(collection(db, "messages"), orderBy("time")), snap => {
    const box = document.getElementById("messages"); box.innerHTML = "";
    snap.forEach(d => {
        const m = d.data(); const div = document.createElement("div");
        div.className = `message ${m.isSystem ? 'sys-msg' : ''}`;
        div.innerHTML = m.isSystem ? m.text : `<b style="color:${m.color}">${m.user}:</b> ${m.text}`;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
});

onSnapshot(collection(db, "users"), snap => {
    allPlayerIDs = snap.docs.map(d => d.id).sort();
    document.getElementById("playerCount").textContent = snap.size;
    const list = document.getElementById("playerList"); list.innerHTML = "";
    snap.forEach(d => {
        const p = document.createElement("div"); p.style.color = d.data().color;
        p.textContent = "â— " + d.data().username; list.appendChild(p);
    });
});

onSnapshot(doc(db, "game", "session"), snap => {
    const data = snap.data();
    if (!data || !data.active) { localTimerEnd = 0; currentPhase = ""; return; }
    localTimerEnd = data.timerEnd;
    if (currentPhase !== data.phase) { currentPhase = data.phase; roleShown = false; }
    if (data.phase === "reveal" && !roleShown && data.imposter) {
        roleShown = true;
        const div = document.createElement("div"); div.className = "message sys-msg";
        div.textContent = (username === data.imposter) ? "âš ï¸ YOU ARE IMPOSTER" : `âœ… TOPIC: ${data.topic}`;
        document.getElementById("messages").appendChild(div);
    }
});

document.getElementById("cancelBtn").onclick = () => document.getElementById("inviteBox").style.display = "none";
document.getElementById("resetGameBtn").onclick = () => location.reload();
document.getElementById("logoutBtn").onclick = () => { localStorage.clear(); location.reload(); };
</script>
</body>
</html>
