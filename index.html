<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Room - Topic Edition</title>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #0a0a0c; color: #e0e0e0; overflow: hidden; }

        /* Overlay UI */
        .overlay-card { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
            background: #2c3e50; border: 2px solid #3498db; padding: 15px 25px; 
            border-radius: 12px; z-index: 9999; display: none; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #loginScreen { 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            background: url("https://i.pinimg.com/originals/d5/84/0b/d5840b194bc468e606984aa99f6558c8.gif") center/cover; 
            position: relative; 
            z-index: 10; 
        }

        #loginScreen::before { 
            content: ""; 
            position: absolute; 
            inset: 0; 
            background: rgba(0, 0, 0, 0.75); 
            backdrop-filter: blur(4px); 
        }
        #loginContainer { 
            position: relative; 
            z-index: 2; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }

        #loginContainer input { 
            margin: 10px; 
            padding: 15px; 
            width: 280px; 
            border-radius: 12px; 
            border: 1px solid #444; 
            background: #1a1a1a; 
            color: white; 
            outline: none; 
        }

        .app { 
            height: 100vh; 
            display: none; 
            flex-direction: row; 
            background: #0f0f13; 
        }

        .sidebar { 
            width: 220px; 
            background: #16161d; 
            border-right: 1px solid #2d2d3d; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
        }


        #playerList { 
            flex: 1; 
            overflow-y: auto; 
            margin-top: 10px; 
        }
        
        .chat-main { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
        }

        .header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 12px 20px; 
            background: #16161d; 
            border-bottom: 1px solid #2d2d3d; 
        }
        
        #phaseTimerDisplay { 
            background: #e74c3c; 
            color: white; 
            padding: 4px 10px; 
            border-radius: 5px; 
            font-family: monospace; 
            font-weight: bold; 
            display: none; 
        }

        #messages { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            background: #0f0f13; 
        }

        .message { 
            padding: 10px 15px; 
            border-radius: 12px; 
            background: rgba(255, 255, 255, 0.05); 
            max-width: 85%; 
        }

        .sys-msg { 
            background: #f1c40f !important; 
            color: #000 !important; 
            font-weight: 900; 
            text-align: center; 
            max-width: 100%; 
            border: 2px solid #000; 
        }

        .topic-msg { 
            background: #3498db !important; 
            color: white !important; 
            font-style: italic; 
            border: 1px solid #fff; 
        }

        .inputBar { 
            display: flex; 
            padding: 20px; 
            background: #16161d; 
            gap: 10px; 
            border-top: 1px solid #2d2d3d; 
        }

        .inputBar input { 
            flex: 1; 
            padding: 14px;
            border-radius: 10px; 
            border: 1px solid #3d3d4d; 
            background: #0a0a0c; 
            color: white; 
        }

        button { 
            cursor: pointer; 
            border: none; 
            border-radius: 10px; 
            font-weight: bold; 
            padding: 10px 20px; 
        }
        
    </style>
</head>
<body>

<div id="inviteBox" class="overlay-card">
    <p id="inviteText">Invitation</p>
    <button id="joinBtn" style="background:#2ecc71; color:white;">ACCEPT & JOIN</button>
</div>

<div id="resetBox" class="overlay-card" style="border-color: #e67e22;">
    <p>Reset Game? (<span id="resetCount">0</span>/2 Votes)</p>
    <button id="resetYesBtn" style="background:#e67e22; color:white;">VOTE YES</button>
</div>

<div id="loginScreen">
    <div id="loginContainer">
        <h1 style="color:white; letter-spacing: 5px;">MINI ROOM</h1>
        <input id="usernameInput" placeholder="Enter Username...">
        <input type="color" id="colorPicker" value="#3498db" style="height: 50px;">
        <button id="loginBtn" style="background:#3498db; color:white; width:280px; margin-top: 10px;">ENTER SYSTEM</button>
    </div>
</div>

<div class="app" id="chatApp">
    <div class="sidebar">
        <h3>ONLINE (<span id="playerCount">0</span>)</h3>
        <div id="playerList"></div>
        <button id="startResetVote" style="background:#e67e22; color:white; font-size:11px; margin-top:10px;">VOTE RESET</button>
    </div>
    <div class="chat-main">
        <div class="header">
            <div style="display:flex; align-items:center; gap:10px;">
                <b style="color:#3498db;">MINI ROOM</b>
                <span id="phaseTimerDisplay"></span>
            </div>
            <button id="logoutBtn" style="background:#e74c3c; color:white; padding:5px 10px;">LEAVE</button>
        </div>
        <div id="messages"></div>
        <div class="inputBar">
            <input id="messageInput" placeholder="Type a message..." autocomplete="off">
            <button id="sendBtn" style="background:#3498db; color:white;">SEND</button>
        </div>
        <div style="padding:15px; background:#16161d; border-top:1px solid #2d2d3d;">
            <button id="startBtn" style="background:#8e44ad; color:white; width:100%;">INVITE OTHERS TO PLAY</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, setDoc, updateDoc, deleteDoc, getDocs, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyA3wCv1DIdjlPS-zEVQJXhjYsiC3G2dBJY",
    authDomain: "mini-chatroom-5710b.firebaseapp.com",
    projectId: "mini-chatroom-5710b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let myID = localStorage.getItem("myID") || Math.random().toString(36).slice(2);
localStorage.setItem("myID", myID);
let username = localStorage.getItem("username") || "";
let myColor = localStorage.getItem("userColor") || "#3498db";
let myStatus = "alive";
let isImposter = false;
let currentPhase = "";
let countdownInterval = null;

const TOPICS = [
    "Haewon's bsdm",
    "Crush",
    "ex",
    "Sugar Daddy",
    "Emo",
    "Ariana Grande",
    "Bruno Mars",
    "Daniel Caesar",
    "Bathroom",
    "Window",
    "Phone",
    "Goku's panties"
];

if(username) {
    document.getElementById("loginScreen").style.display="none";
    document.getElementById("chatApp").style.display="flex";
}

async function postSys(text, isTopic = false) {
    await addDoc(collection(db, "messages"), { 
        user: "SYSTEM", text, time: Date.now(), isSystem: true, isTopic 
    });
}

// Fixed Login
document.getElementById("loginBtn").onclick = async () => {
    const name = document.getElementById("usernameInput").value.trim();
    if(!name) return;
    localStorage.setItem("username", name);
    localStorage.setItem("userColor", document.getElementById("colorPicker").value);
    await setDoc(doc(db, "users", myID), { username: name, color: document.getElementById("colorPicker").value, status: "alive", id: myID });
    location.reload();
};

/* ---------------- GAME LOOP ---------------- */

onSnapshot(doc(db, "game", "session"), async snap => {
    const data = snap.data();
    if(!data || !data.active) return;
    
    currentPhase = data.phase;
    isImposter = (username === data.imposter);

    if(data.phase === "reveal") {
        const roleMsg = isImposter ? "ü§´ YOU ARE THE IMPOSTER!" : "üòá YOU ARE A CIVILIAN.";
        document.getElementById("messages").innerHTML += `<div class="message sys-msg" style="background:#9b59b6 !important; color:white !important;">${roleMsg}</div>`;
    }

    if(countdownInterval) clearInterval(countdownInterval);
    countdownInterval = setInterval(async () => {
        const remaining = Math.max(0, Math.floor((data.timerEnd - Date.now())/1000));
        document.getElementById("phaseTimerDisplay").style.display = "block";
        document.getElementById("phaseTimerDisplay").textContent = remaining + "s";

        if(remaining <= 0) {
            clearInterval(countdownInterval);
            const users = await getDocs(collection(db, "users"));
            const host = users.docs.map(d => d.id).sort()[0];

            if(myID === host) {
                if(data.phase === "rules") {
                    const names = users.docs.map(u => u.data().username);
                    const imp = names[Math.floor(Math.random()*names.length)];
                    await updateDoc(doc(db, "game", "session"), { phase: "reveal", timerEnd: Date.now() + 5000, imposter: imp });
                } else if(data.phase === "reveal") {
                    const randomTopic = TOPICS[Math.floor(Math.random() * TOPICS.length)];
                    await postSys(`üó£Ô∏è DISCUSSION START! TOPIC: ${randomTopic}`, true);
                    await updateDoc(doc(db, "game", "session"), { phase: "discussion", timerEnd: Date.now() + 25000 });
                } else if(data.phase === "discussion") {
                    await postSys("üó≥Ô∏è VOTING START! /vote [Name]");
                    await updateDoc(doc(db, "game", "session"), { phase: "voting", timerEnd: Date.now() + 20000 });
                } else if(data.phase === "voting") {
                    await postSys("üî™ IMPOSTER ROUND!");
                    await updateDoc(doc(db, "game", "session"), { phase: "round2", timerEnd: Date.now() + 15000 });
                } else if(data.phase === "round2") {
                    const randomTopic = TOPICS[Math.floor(Math.random() * TOPICS.length)];
                    await postSys(`üîÑ ROUND OVER. NEW TOPIC: ${randomTopic}`, true);
                    await updateDoc(doc(db, "game", "session"), { phase: "discussion", timerEnd: Date.now() + 25000 });
                }
            }
        }
    }, 1000);
});

// Message Rendering with Topic Support
onSnapshot(query(collection(db, "messages"), orderBy("time")), snap => {
    const box = document.getElementById("messages"); box.innerHTML = "";
    snap.forEach(d => {
        const m = d.data();
        const typeClass = m.isTopic ? 'topic-msg' : (m.isSystem ? 'sys-msg' : '');
        box.innerHTML += `<div class="message ${typeClass}">${m.isSystem ? '' : `<b style="color:${m.color}">${m.user}:</b> `}${m.text}</div>`;
    });
    box.scrollTop = box.scrollHeight;
});

/* ---------------- RE-ADDED CONSENT LOGIC ---------------- */
document.getElementById("startBtn").onclick = async () => {
    await setDoc(doc(db, "game", "lobby"), { requester: username, voters: [username], active: true });
};
document.getElementById("joinBtn").onclick = async () => {
    await updateDoc(doc(db, "game", "lobby"), { voters: arrayUnion(username) });
    document.getElementById("inviteBox").style.display = "none";
};
onSnapshot(doc(db, "game", "lobby"), async snap => {
    const data = snap.data();
    if(!data || !data.active) { document.getElementById("inviteBox").style.display = "none"; return; }
    if(!data.voters.includes(username)) {
        document.getElementById("inviteText").textContent = `${data.requester} wants to play!`;
        document.getElementById("inviteBox").style.display = "block";
    }
    if(data.voters.length >= 2) {
        const users = await getDocs(collection(db, "users"));
        if(myID === users.docs.map(d => d.id).sort()[0]) {
            await setDoc(doc(db, "game", "session"), { phase: "rules", timerEnd: Date.now() + 15000, active: true });
            await setDoc(doc(db, "game", "lobby"), { active: false });
        }
    }
});

document.getElementById("startResetVote").onclick = async () => { await setDoc(doc(db, "game", "reset"), { voters: [username], active: true }); };
document.getElementById("resetYesBtn").onclick = async () => { await updateDoc(doc(db, "game", "reset"), { voters: arrayUnion(username) }); };
onSnapshot(doc(db, "game", "reset"), async snap => {
    const data = snap.data();
    if(!data || !data.active) { document.getElementById("resetBox").style.display = "none"; return; }
    document.getElementById("resetBox").style.display = "block";
    document.getElementById("resetCount").textContent = data.voters.length;
    if(data.voters.length >= 2) {
        const users = await getDocs(collection(db, "users"));
        if(myID === users.docs.map(d => d.id).sort()[0]) {
            const msgs = await getDocs(collection(db, "messages"));
            for(const m of msgs.docs) await deleteDoc(doc(db, "messages", m.id));
            await setDoc(doc(db, "game", "session"), { active: false });
            await setDoc(doc(db, "game", "reset"), { active: false });
            location.reload();
        }
    }
});

window.sendMessage = async function() {
    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if(!text || myStatus === "dead") { input.value = ""; return; }
    await addDoc(collection(db, "messages"), { user: username, text, time: Date.now(), color: myColor });
    input.value = "";
}
document.getElementById("sendBtn").onclick = window.sendMessage;
document.getElementById("messageInput").onkeydown = (e) => { if(e.key === "Enter") window.sendMessage(); };

onSnapshot(collection(db, "users"), snap => {
    const list = document.getElementById("playerList"); list.innerHTML = "";
    document.getElementById("playerCount").textContent = snap.size;
    snap.forEach(d => {
        const u = d.data(); if(u.id === myID) myStatus = u.status;
        list.innerHTML += `<div style="color:${u.status==='dead'?'#777':u.color}">${u.status==='dead'?'üíÄ':'‚óè'} ${u.username}</div>`;
    });
});
</script>
</body>
</html>
